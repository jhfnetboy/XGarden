<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3000World-demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/jquery/3.6.0/jquery.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif, system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
        }

        .chat-bubble {
            max-width: 80%;
            width: fit-content;
        }

        .chat-bubble-user {
            background-color: #3b82f6;
            color: white;
            align-self: flex-end;
        }

        .chat-bubble-char {
            background-color: #4b5563;
            color: white;
            align-self: flex-start;
        }

        .speaker-name {
            font-size: 0.8rem;
            font-weight: bold;
            color: #d1d5db;
            margin-bottom: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1f2937;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        .sidebar-item:hover,
        .sidebar-item.active {
            background-color: #374151;
        }

        #group-char-selection label {
            display: block;
            margin-bottom: 0.5rem;
        }

        .shake {
            animation: shake 0.5s;
        }

        @keyframes shake {

            10%,
            90% {
                transform: translate3d(-1px, 0, 0);
            }

            20%,
            80% {
                transform: translate3d(2px, 0, 0);
            }

            30%,
            50%,
            70% {
                transform: translate3d(-4px, 0, 0);
            }

            40%,
            60% {
                transform: translate3d(4px, 0, 0);
            }
        }
    </style>
</head>

<body class="bg-gray-900 text-white overflow-hidden">

    <!-- Toast Notification -->
    <div id="toast-notification" class="hidden fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-50">
    </div>

    <!-- World Selection Dialog -->
    <div id="world-selector-dialog"
        class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-40">
        <div class="bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-md relative">
            <div class="absolute top-4 right-4">
                <button id="lang-switcher" class="text-sm text-gray-400 hover:text-white"
                    data-i18n="langSwitcherLabel">è¯­è¨€: ç®€ä½“ä¸­æ–‡</button>
            </div>
            <h2 class="text-3xl font-bold text-center mb-6" data-i18n="appTitle">3000World</h2>
            <div id="existing-worlds-container">
                <h3 class="text-lg font-semibold mb-3" data-i18n="selectWorldTitle">é€‰æ‹©ä¸€ä¸ªä¸–ç•Œ</h3>
                <div class="flex space-x-3 mb-6">
                    <select id="world-select-dropdown"
                        class="flex-grow bg-gray-700 p-3 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
                    <button id="enter-world-btn"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-5 rounded-lg"
                        data-i18n="enterWorldBtn">è¿›å…¥</button>
                </div>
            </div>
            <div>
                <h3 class="text-lg font-semibold mb-3" data-i18n="createWorldTitle">æˆ–è€…, åˆ›å»ºä¸€ä¸ªæ–°ä¸–ç•Œ</h3>
                <div class="flex space-x-3 mb-4">
                    <input type="text" id="new-world-name" data-i18n-placeholder="newWorldPlaceholder"
                        placeholder="è¾“å…¥æ–°ä¸–ç•Œçš„åç§°..."
                        class="flex-grow bg-gray-700 p-3 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <button id="create-world-btn"
                        class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-5 rounded-lg"
                        data-i18n="createWorldBtn">åˆ›å»º</button>
                </div>
                <div class="border-t border-gray-600 pt-4">
                    <h3 class="text-lg font-semibold mb-3" data-i18n="importWorldTitle">å¯¼å…¥ä¸–ç•Œ</h3>
                    <div class="flex flex-col space-y-3">
                        <input type="file" id="import-world-file" accept=".json" 
                            class="hidden">
                        <button id="import-world-btn"
                            class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-5 rounded-lg"
                            data-i18n="importWorldBtn">é€‰æ‹©JSONæ–‡ä»¶å¯¼å…¥</button>
                        <div id="import-status" class="text-sm text-gray-400 hidden"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application UI (Initially Hidden) -->
    <div id="main-app" class="hidden flex h-screen">
        <!-- Left Sidebar -->
        <aside class="w-1/4 bg-gray-800 p-4 flex flex-col custom-scrollbar overflow-y-auto">
            <div class="flex-grow">
                <div class="mb-6">
                    <h2 class="text-xl font-bold mb-3" data-i18n="groupChatTitle">ç¾¤èŠ</h2>
                    <button id="new-group-btn"
                        class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg mb-3"
                        data-i18n="newGroupBtn">åˆ›å»ºæ–°ç¾¤ç»„</button>
                    <ul id="group-list" class="space-y-2"></ul>
                </div>
                <div class="mb-6">
                    <h2 class="text-xl font-bold mb-3" data-i18n="characterCardTitle">è§’è‰²å¡ç‰‡</h2>
                    <button id="new-char-btn"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg mb-3"
                        data-i18n="newCharBtn">åˆ›å»ºæ–°è§’è‰²</button>
                    <ul id="char-list" class="space-y-2"></ul>
                </div>
                <div>
                    <h2 class="text-xl font-bold mb-3" data-i18n="worldBookTitle">ä¸–ç•Œä¹‹ä¹¦</h2>
                    <button id="new-world-btn"
                        class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg mb-3"
                        data-i18n="newWorldEntryBtn">åˆ›å»ºæ–°æ¡ç›®</button>
                    <ul id="world-list" class="space-y-2"></ul>
                </div>
            </div>
            <div class="flex-shrink-0">
                <h2 class="text-xl font-bold mb-3" data-i18n="worldSettingsTitle">ä¸–ç•Œé…ç½®</h2>
                <button id="edit-config-btn"
                    class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg"
                    data-i18n="editConfigBtn">ç¼–è¾‘é…ç½®</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="w-1/2 bg-gray-900 flex flex-col p-4 h-screen">
            <div id="chat-welcome" class="flex flex-col items-center justify-center h-full text-center">
                <h1 class="text-3xl font-bold text-gray-400" data-i18n="welcomeTitle">æ¬¢è¿ä½¿ç”¨</h1>
                <p class="text-gray-500 mt-2" data-i18n="welcomeMessage">ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªç¾¤ç»„æˆ–è§’è‰²å¼€å§‹å¯¹è¯ã€‚</p>
            </div>
            <div id="chat-area" class="hidden flex-1 flex flex-col min-h-0">
                <div id="chat-header" class="border-b-2 border-gray-700 pb-2 mb-4 flex-shrink-0">
                    <h2 id="chat-session-name" class="text-2xl font-bold"></h2>
                    <p id="chat-participants" class="text-sm text-gray-400"></p>
                </div>
                <div id="chat-history-container"
                    class="flex-1 custom-scrollbar overflow-y-auto pr-4 h-[calc(100vh-12rem)]">
                    <div id="chat-history" class="space-y-4 flex flex-col"></div>
                </div>
                <div class="mt-4 relative flex-shrink-0">
                    <div id="mention-suggestions"
                        class="hidden absolute bottom-full mb-2 w-full bg-gray-700 border border-gray-600 rounded-lg shadow-lg z-10 max-h-48 overflow-y-auto custom-scrollbar">
                    </div>
                    <div class="flex items-center">
                        <textarea id="user-input"
                            class="w-full p-3 bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
                            data-i18n-placeholder="userInputPlaceholder" placeholder="è¾“å…¥ä½ çš„æ¶ˆæ¯, å¯ä½¿ç”¨ @ æ¥æåŠè§’è‰²..."
                            rows="2"></textarea>
                        <button id="send-btn"
                            class="ml-3 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-5 rounded-lg"
                            data-i18n="sendBtn">å‘é€</button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Right Sidebar -->
        <aside class="w-1/4 bg-gray-800 p-6 custom-scrollbar overflow-y-auto">
            <div id="editor-panel">
                <div id="editor-welcome" class="text-gray-500">
                    <h3 class="text-xl font-bold mb-2" data-i18n="editorTitle">ç¼–è¾‘å™¨</h3>
                    <p data-i18n="editorWelcomeMessage">ç‚¹å‡» "åˆ›å»º" æˆ–é€‰æ‹©ç°æœ‰æ¡ç›®è¿›è¡Œç¼–è¾‘ã€‚</p>
                </div>
                <form id="config-editor" class="hidden space-y-4"></form>
                <form id="group-editor" class="hidden space-y-4"></form>
                <form id="char-editor" class="hidden space-y-4"></form>
                <form id="world-editor" class="hidden space-y-4"></form>
            </div>
        </aside>
    </div>

    <script>
        $(async function () { // Document Ready

            // --- I18N SETUP ---
            const i18n = {
                'zh-CN': {
                    langSwitcherLabel: 'è¯­è¨€: ç®€ä½“ä¸­æ–‡', appTitle: '3000World',
                    selectWorldTitle: 'é€‰æ‹©ä¸€ä¸ªä¸–ç•Œ', enterWorldBtn: 'è¿›å…¥',
                    createWorldTitle: 'æˆ–è€…, åˆ›å»ºä¸€ä¸ªæ–°ä¸–ç•Œ', newWorldPlaceholder: 'è¾“å…¥æ–°ä¸–ç•Œçš„åç§°...', createWorldBtn: 'åˆ›å»º',
                    importWorldTitle: 'å¯¼å…¥ä¸–ç•Œ', importWorldBtn: 'é€‰æ‹©JSONæ–‡ä»¶å¯¼å…¥',
                    groupChatTitle: 'ç¾¤èŠ', newGroupBtn: 'åˆ›å»ºæ–°ç¾¤ç»„',
                    characterCardTitle: 'è§’è‰²å¡ç‰‡', newCharBtn: 'åˆ›å»ºæ–°è§’è‰²',
                    worldBookTitle: 'ä¸–ç•Œä¹‹ä¹¦', newWorldEntryBtn: 'åˆ›å»ºæ–°æ¡ç›®',
                    worldSettingsTitle: 'ä¸–ç•Œé…ç½®', editConfigBtn: 'ç¼–è¾‘é…ç½®',
                    welcomeTitle: 'æ¬¢è¿ä½¿ç”¨', welcomeMessage: 'ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªç¾¤ç»„æˆ–è§’è‰²å¼€å§‹å¯¹è¯ã€‚',
                    userInputPlaceholder: 'è¾“å…¥ä½ çš„æ¶ˆæ¯, å¯ä½¿ç”¨ @ æ¥æåŠè§’è‰²...', sendBtn: 'å‘é€',
                    editorTitle: 'ç¼–è¾‘å™¨', editorWelcomeMessage: 'ç‚¹å‡» "åˆ›å»º" æˆ–é€‰æ‹©ç°æœ‰æ¡ç›®è¿›è¡Œç¼–è¾‘ã€‚',
                    configEditorTitle: 'ä¸–ç•Œé…ç½®', apiKeyLabel: 'API Key', apiUrlLabel: 'API URL', modelLabel: 'æ¨¡å‹ (Model)', saveConfigBtn: 'ä¿å­˜é…ç½®',
                    alertWorldNameEmpty: 'ä¸–ç•Œåç§°ä¸èƒ½ä¸ºç©ºï¼', alertSelectWorld: 'è¯·ä»ä¸‹æ‹‰åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªä¸–ç•Œã€‚',
                    alertEnterWorldFailed: 'è¿›å…¥ä¸–ç•Œå¤±è´¥', alertConfigSaved: 'é…ç½®å·²ä¿å­˜ï¼', alertLangChanged: 'è¯­è¨€å·²åˆ‡æ¢ï¼',
                    charNameCannotBeEmpty: 'è§’è‰²åç§°ä¸èƒ½ä¸ºç©ºã€‚', groupNeedOneChar: 'ç¾¤èŠè‡³å°‘éœ€è¦1ä¸ªè§’è‰²ã€‚',
                    deleteConfirm: 'ç¡®è®¤åˆ é™¤ï¼Ÿ', deleteChar: 'åˆ é™¤è§’è‰²', deleteGroup: 'åˆ é™¤ç¾¤ç»„', deleteEntry: 'åˆ é™¤æ¡ç›®',
                    playerCharLabel: 'è®¾ä¸ºä¸»è§’ï¼ˆç”¨æˆ·å°†ä»¥æ­¤è§’è‰²èº«ä»½å¯¹è¯ï¼‰', playerCharCrown: 'ğŸ‘‘ ä¸»è§’'
                },
                'en-US': {
                    langSwitcherLabel: 'Language: English', appTitle: '3000World',
                    selectWorldTitle: 'Select a World', enterWorldBtn: 'Enter',
                    createWorldTitle: 'Or, Create a New World', newWorldPlaceholder: 'Enter new world name...', createWorldBtn: 'Create',
                    importWorldTitle: 'Import World', importWorldBtn: 'Select JSON File to Import',
                    groupChatTitle: 'Group Chats', newGroupBtn: 'New Group',
                    characterCardTitle: 'Characters', newCharBtn: 'New Character',
                    worldBookTitle: 'Worldbook', newWorldEntryBtn: 'New Entry',
                    worldSettingsTitle: 'World Settings', editConfigBtn: 'Edit Settings',
                    welcomeTitle: 'Welcome', welcomeMessage: 'Select a group or character from the left to start chatting.',
                    userInputPlaceholder: 'Type your message, use @ to mention characters...', sendBtn: 'Send',
                    editorTitle: 'Editor', editorWelcomeMessage: 'Click "Create" or select an existing item to edit.',
                    configEditorTitle: 'World Settings', apiKeyLabel: 'API Key', apiUrlLabel: 'API URL', modelLabel: 'Model', saveConfigBtn: 'Save Settings',
                    alertWorldNameEmpty: 'World name cannot be empty!', alertSelectWorld: 'Please select a world from the dropdown.',
                    alertEnterWorldFailed: 'Failed to enter world', alertConfigSaved: 'Settings saved!', alertLangChanged: 'Language Changed!',
                    charNameCannotBeEmpty: 'Character name cannot be empty.', groupNeedOneChar: 'Group chat needs at least one character.',
                    deleteConfirm: 'Confirm Deletion?', deleteChar: 'Delete Character', deleteGroup: 'Delete Group', deleteEntry: 'Delete Entry',
                    playerCharLabel: 'Set as player character (user will chat as this character)', playerCharCrown: 'ğŸ‘‘ Player'
                }
            };

            let currentLang = 'zh-CN';

            function setLanguage(lang, showNotification = false) {
                if (!i18n[lang]) lang = 'zh-CN'; // Fallback
                currentLang = lang;
                localStorage.setItem('3000world-lang', lang);

                const strings = i18n[lang];
                $('[data-i18n]').each(function () {
                    const key = $(this).data('i18n');
                    if (strings[key]) $(this).text(strings[key]);
                });
                $('[data-i18n-placeholder]').each(function () {
                    const key = $(this).data('i18n-placeholder');
                    if (strings[key]) $(this).attr('placeholder', strings[key]);
                });

                if (showNotification) {
                    showToast('alertLangChanged', false);
                }
            }

            function getLanguage() {
                return localStorage.getItem('3000world-lang') || 'zh-CN';
            }

            // --- GLOBAL APP STATE ---
            const DB_PREFIX = '3000World_';
            const DB_VERSION = 3;
            let db;

            let currentState = {
                sessionId: null, sessionType: null,
                characterCache: new Map(),
                worldConfig: { apiKey: '', apiUrl: '', model: '' },
                playerCharacter: null // å­˜å‚¨ä¸»è§’è§’è‰²ä¿¡æ¯
            };

            // --- UTILITY: TOAST NOTIFICATION ---
            function showToast(messageKey, isError = true) {
                const message = i18n[currentLang][messageKey] || messageKey;
                const $toast = $('#toast-notification');
                $toast.text(message)
                    .removeClass('bg-red-500 bg-green-500')
                    .addClass(isError ? 'bg-red-500' : 'bg-green-500')
                    .fadeIn(300);
                setTimeout(() => $toast.fadeOut(300), 3000);
            }

            // --- STARTUP LOGIC: WORLD SELECTION ---
            async function showWorldSelectionDialog() {
                if (!window.indexedDB.databases) {
                    $('#existing-worlds-container').html(`<p class="text-yellow-400 text-sm">${i18n[currentLang].alertBrowserSupport}</p>`);
                    return;
                }

                const databases = await window.indexedDB.databases();
                const worldDbs = databases.filter(db => db.name.startsWith(DB_PREFIX));
                const $dropdown = $('#world-select-dropdown').empty();

                if (worldDbs.length === 0) {
                    $('#existing-worlds-container').hide();
                } else {
                    $('#existing-worlds-container').show();
                    $dropdown.append($('<option>').text(i18n[currentLang].selectWorldTitle + '...').val(''));
                    worldDbs.forEach(dbInfo => {
                        const worldName = dbInfo.name.replace(DB_PREFIX, '');
                        $('<option></option>').text(worldName).val(worldName).appendTo($dropdown);
                    });
                }
            }

            async function enterWorld(worldName) {
                if (!worldName) {
                    const $input = $('#new-world-name');
                    showToast('alertWorldNameEmpty');
                    $input.addClass('shake border-red-500').focus();
                    setTimeout(() => $input.removeClass('shake border-red-500'), 500);
                    return;
                }

                const dbName = `${DB_PREFIX}${worldName}`;
                try {
                    db = await initDB(dbName);
                    await loadWorldConfig();
                    $('#world-selector-dialog').fadeOut(300);
                    $('#main-app').removeClass('hidden');
                    initializeAppLogic();
                } catch (error) {
                    showToast(`${i18n[currentLang].alertEnterWorldFailed}: ${error}`);
                }
            }

            async function importWorld(worldData, worldName) {
                const dbName = `${DB_PREFIX}${worldName}`;
                try {
                    // åˆ›å»ºæ–°çš„æ•°æ®åº“
                    db = await initDB(dbName);
                    
                    // å¯¼å…¥è§’è‰²æ•°æ®
                    if (worldData.characters && worldData.characters.length > 0) {
                        const charStore = getStore('characters', 'readwrite');
                        for (const char of worldData.characters) {
                            const { id, ...charData } = char; // ç§»é™¤åŸIDï¼Œè®©æ•°æ®åº“è‡ªåŠ¨ç”Ÿæˆæ–°ID
                            charStore.add(charData);
                        }
                    }
                    
                    // å¯¼å…¥ç¾¤ç»„æ•°æ®
                    if (worldData.groups && worldData.groups.length > 0) {
                        const groupStore = getStore('groups', 'readwrite');
                        for (const group of worldData.groups) {
                            const { id, ...groupData } = group;
                            groupStore.add(groupData);
                        }
                    }
                    
                    // å¯¼å…¥ä¸–ç•Œè®¾å®šæ•°æ®
                    if (worldData.worldbooks && worldData.worldbooks.length > 0) {
                        const worldStore = getStore('worldbooks', 'readwrite');
                        for (const entry of worldData.worldbooks) {
                            const { id, ...entryData } = entry;
                            worldStore.add(entryData);
                        }
                    }
                    
                    // å¯¼å…¥é…ç½®æ•°æ®
                    if (worldData.config) {
                        const configStore = getStore('config', 'readwrite');
                        configStore.put(worldData.config.apiKey || '', 'apiKey');
                        configStore.put(worldData.config.apiUrl || 'https://api.deepinfra.com/v1/openai/chat/completions', 'apiUrl');
                        configStore.put(worldData.config.model || 'deepseek-ai/DeepSeek-R1-Turbo', 'model');
                    }
                    
                    // ç­‰å¾…æ‰€æœ‰æ“ä½œå®Œæˆ
                    await new Promise(resolve => {
                        const transaction = db.transaction(['characters', 'groups', 'worldbooks', 'config'], 'readwrite');
                        transaction.oncomplete = resolve;
                    });
                    
                    await loadWorldConfig();
                    $('#world-selector-dialog').fadeOut(300);
                    $('#main-app').removeClass('hidden');
                    initializeAppLogic();
                    
                    return true;
                } catch (error) {
                    console.error('Import error:', error);
                    throw error;
                }
            }

            function handleImportFile() {
                const fileInput = document.getElementById('import-world-file');
                const file = fileInput.files[0];
                
                if (!file) return;
                
                const $status = $('#import-status');
                $status.removeClass('hidden text-red-400 text-green-400').addClass('text-blue-400').text('æ­£åœ¨è¯»å–æ–‡ä»¶...');
                
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const worldData = JSON.parse(e.target.result);
                        
                        // éªŒè¯JSONç»“æ„
                        if (!worldData.worldName) {
                            throw new Error('JSONæ–‡ä»¶ç¼ºå°‘worldNameå­—æ®µ');
                        }
                        
                        $status.text('æ­£åœ¨å¯¼å…¥ä¸–ç•Œæ•°æ®...');
                        
                        await importWorld(worldData, worldData.worldName);
                        
                        $status.removeClass('text-blue-400').addClass('text-green-400').text('ä¸–ç•Œå¯¼å…¥æˆåŠŸï¼');
                        
                    } catch (error) {
                        console.error('Import failed:', error);
                        $status.removeClass('text-blue-400').addClass('text-red-400').text(`å¯¼å…¥å¤±è´¥: ${error.message}`);
                    }
                };
                
                reader.onerror = function() {
                    $status.removeClass('text-blue-400').addClass('text-red-400').text('æ–‡ä»¶è¯»å–å¤±è´¥');
                };
                
                reader.readAsText(file);
            }

            // --- DATABASE (IndexedDB) SETUP ---
            function initDB(dbName) {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(dbName, DB_VERSION);
                    request.onerror = e => reject(`Database error: ${e.target.error}`);
                    request.onupgradeneeded = e => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('characters')) db.createObjectStore('characters', { keyPath: 'id', autoIncrement: true });
                        if (!db.objectStoreNames.contains('worldbooks')) db.createObjectStore('worldbooks', { keyPath: 'id', autoIncrement: true });
                        if (!db.objectStoreNames.contains('groups')) db.createObjectStore('groups', { keyPath: 'id', autoIncrement: true });
                        if (!db.objectStoreNames.contains('config')) db.createObjectStore('config');
                        if (db.objectStoreNames.contains('chat_history')) db.deleteObjectStore('chat_history');
                        const chatStore = db.createObjectStore('chat_history', { keyPath: 'id', autoIncrement: true });
                        chatStore.createIndex('sessionId', 'sessionId', { unique: false });
                    };
                    request.onsuccess = e => {
                        console.log(`Successfully connected to world: ${dbName}`);
                        resolve(e.target.result);
                    };
                });
            }

            // --- CONFIGURATION MANAGEMENT ---
            async function loadWorldConfig() {
                const store = getStore('config', 'readonly');
                const [apiKeyReq, apiUrlReq, modelReq] = [store.get('apiKey'), store.get('apiUrl'), store.get('model')];

                const apiKey = await new Promise(r => { apiKeyReq.onsuccess = () => r(apiKeyReq.result); apiKeyReq.onerror = () => r(undefined); });
                const apiUrl = await new Promise(r => { apiUrlReq.onsuccess = () => r(apiUrlReq.result); apiUrlReq.onerror = () => r(undefined); });
                const model = await new Promise(r => { modelReq.onsuccess = () => r(modelReq.result); modelReq.onerror = () => r(undefined); });

                if (apiKey === undefined || apiUrl === undefined || model === undefined) {
                    // const defaultConfig = {
                    //     apiKey: '',
                    //     apiUrl: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent',
                    //     model: 'gemini-2.0-flash'
                    // };
                    const defaultConfig = {
                        apiKey: '',
                        apiUrl: 'https://api.deepinfra.com/v1/openai/chat/completions',
                        model: 'deepseek-ai/DeepSeek-R1-Turbo'
                    };
                    const writeTx = db.transaction('config', 'readwrite');
                    const writeStore = writeTx.objectStore('config');
                    writeStore.put(defaultConfig.apiKey, 'apiKey');
                    writeStore.put(defaultConfig.apiUrl, 'apiUrl');
                    writeStore.put(defaultConfig.model, 'model');
                    await new Promise(r => writeTx.oncomplete = r);
                    currentState.worldConfig = defaultConfig;
                } else {
                    currentState.worldConfig = { apiKey, apiUrl, model };
                }
            }

            function saveWorldConfig(e) {
                e.preventDefault();
                const newConfig = {
                    apiKey: $('#config-api-key').val(),
                    apiUrl: $('#config-api-url').val(),
                    model: $('#config-model').val()
                };
                const store = getStore('config', 'readwrite');
                store.put(newConfig.apiKey, 'apiKey');
                store.put(newConfig.apiUrl, 'apiUrl');
                store.put(newConfig.model, 'model');
                currentState.worldConfig = newConfig;
                showToast('alertConfigSaved', false);
                showEditor(null);
            }

            function editWorldConfig() {
                clearForms();
                $('#config-api-key').val(currentState.worldConfig.apiKey);
                $('#config-api-url').val(currentState.worldConfig.apiUrl);
                $('#config-model').val(currentState.worldConfig.model);
                showEditor('config');
            }

            // --- UTILITY & CORE FUNCTIONS ---
            function getStore(storeName, mode) {
                return db.transaction(storeName, mode).objectStore(storeName);
            }

            function showEditor(type) {
                $('#editor-welcome, #char-editor, #world-editor, #group-editor, #config-editor').hide();
                if (type) $(`#${type}-editor`).show();
                else { $('#editor-welcome').show(); clearForms(); }
            }

            function clearForms() {
                $('form').each(function () { this.reset(); });
                $('input[type=hidden]').val('');
                const buttons = { 'delete-char-btn': 'deleteChar', 'delete-group-btn': 'deleteGroup', 'delete-world-btn': 'deleteEntry' };
                for (const [btnId, textKey] of Object.entries(buttons)) {
                    $(`#${btnId}`).hide().removeAttr('data-confirming').text(i18n[currentLang][textKey])
                        .removeClass('bg-yellow-500 hover:bg-yellow-600').addClass('bg-red-600 hover:bg-red-700');
                }
            }

            async function cacheAllCharacters() {
                currentState.characterCache.clear();
                currentState.playerCharacter = null; // é‡ç½®ä¸»è§’ä¿¡æ¯
                const store = getStore('characters', 'readonly');
                const chars = await new Promise((res, rej) => {
                    const req = store.getAll(); req.onsuccess = () => res(req.result); req.onerror = () => rej(req.error);
                });
                for (const char of chars) {
                    currentState.characterCache.set(char.id, char);
                    // å¦‚æœæ˜¯ä¸»è§’ï¼Œæ›´æ–°ä¸»è§’ä¿¡æ¯
                    if (char.isPlayer) {
                        currentState.playerCharacter = char;
                    }
                }
            }

            function populateEditors() {
                const t = i18n[currentLang];
                $('#config-editor').html(`<h3 class="text-xl font-bold mb-4">${t.configEditorTitle}</h3><div><label for="config-api-key" class="block text-sm font-medium">${t.apiKeyLabel}</label><input type="text" id="config-api-key" class="w-full mt-1 p-2 bg-gray-700 rounded-lg"></div><div><label for="config-api-url" class="block text-sm font-medium">${t.apiUrlLabel}</label><input type="text" id="config-api-url" class="w-full mt-1 p-2 bg-gray-700 rounded-lg"></div><div><label for="config-model" class="block text-sm font-medium">${t.modelLabel}</label><input type="text" id="config-model" class="w-full mt-1 p-2 bg-gray-700 rounded-lg"></div><div class="flex"><button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">${t.saveConfigBtn}</button></div>`);
                $('#char-editor').html(`<input type="hidden" id="char-id"><div><label for="char-name" class="block text-sm font-medium">è§’è‰²åç§°</label><input type="text" id="char-name" class="w-full mt-1 p-2 bg-gray-700 rounded-lg" required></div><div><label for="char-persona" class="block text-sm font-medium">è§’è‰²è®¾å®š</label><textarea id="char-persona" rows="8" class="w-full mt-1 p-2 bg-gray-700 rounded-lg" required></textarea></div><div><label for="char-greeting" class="block text-sm font-medium">å¼€åœºç™½</label><textarea id="char-greeting" rows="4" class="w-full mt-1 p-2 bg-gray-700 rounded-lg" required></textarea></div><div class="mb-4"><label class="flex items-center space-x-3"><input type="checkbox" id="char-is-player" class="form-checkbox h-5 w-5 bg-gray-800 text-blue-600 rounded"><span class="ml-2" id="player-char-label">${i18n[currentLang].playerCharLabel}</span></label></div><div class="flex space-x-2"><button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">ä¿å­˜è§’è‰²</button><button type="button" id="delete-char-btn" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg hidden" data-i18n="deleteChar">åˆ é™¤è§’è‰²</button></div>`);
                $('#world-editor').html(`<input type="hidden" id="world-id"><div><label for="world-keywords" class="block text-sm font-medium">å…³é”®è¯</label><input type="text" id="world-keywords" class="w-full mt-1 p-2 bg-gray-700 rounded-lg" required></div><div><label for="world-content" class="block text-sm font-medium">å†…å®¹</label><textarea id="world-content" rows="10" class="w-full mt-1 p-2 bg-gray-700 rounded-lg" required></textarea></div><div class="flex space-x-2"><button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">ä¿å­˜æ¡ç›®</button><button type="button" id="delete-world-btn" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg hidden" data-i18n="deleteEntry">åˆ é™¤æ¡ç›®</button></div>`);
                $('#group-editor').html(`<input type="hidden" id="group-id"><div><label for="group-name" class="block text-sm font-medium">ç¾¤ç»„åç§°</label><input type="text" id="group-name" class="w-full mt-1 p-2 bg-gray-700 rounded-lg" required></div><div><label class="block text-sm font-medium">é€‰æ‹©è§’è‰²</label><div id="group-char-selection" class="mt-2 p-2 bg-gray-700 rounded-lg max-h-60 overflow-y-auto custom-scrollbar"></div></div><div class="flex space-x-2"><button type="submit" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">ä¿å­˜ç¾¤ç»„</button><button type="button" id="delete-group-btn" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg hidden" data-i18n="deleteGroup">åˆ é™¤ç¾¤ç»„</button></div>`);
            }

            function renderListItem($listEl, item, type) {
                const $li = $('<li></li>').addClass(`sidebar-item p-2 rounded-lg cursor-pointer flex justify-between items-center ${currentState.sessionId === `${type}_${item.id}` ? 'active' : ''}`);

                // åˆ›å»ºè§’è‰²åç§°å®¹å™¨
                const $nameContainer = $('<div></div>').addClass('flex items-center');

                // å¦‚æœæ˜¯ä¸»è§’è§’è‰²ï¼Œæ·»åŠ ç‰¹æ®Šæ ‡è®°
                if (type === 'character' && item.isPlayer) {
                    $nameContainer.append($('<span></span>').text(i18n[currentLang].playerCharCrown.split(' ')[0] + ' ').addClass('mr-1 text-yellow-400'));
                    $li.addClass('border border-yellow-400');
                }

                // æ·»åŠ è§’è‰²åç§°
                $nameContainer.append($('<span></span>').text(item.name));
                $li.append($nameContainer);

                // æ·»åŠ ç¼–è¾‘æŒ‰é’®
                $li.attr({ 'data-id': item.id, 'data-type': type })
                    .append($('<span></span>').text('âœï¸').addClass('text-sm opacity-50 hover:opacity-100')
                        .on('click', e => {
                            e.stopPropagation();
                            if (type === 'character') editCharacter(item.id);
                            else if (type === 'group') editGroup(item.id);
                        }))
                    .on('click', () => selectSession(item.id, type))
                    .appendTo($listEl);
            }

            async function loadAndRenderAll() { await cacheAllCharacters(); loadCharacters(); loadGroups(); loadWorldbooks(); }
            async function loadCharacters() {
                const $charList = $('#char-list').empty(), $groupCharSel = $('#group-char-selection').empty();
                const chars = Array.from(currentState.characterCache.values());
                if (chars.length === 0) $groupCharSel.html(`<p class="text-gray-400">${i18n[currentLang].groupNeedOneChar}</p>`);
                else chars.forEach(char => {
                    renderListItem($charList, char, 'character');
                    $('<label></label>').addClass('flex items-center space-x-3').append($('<input>').attr({ type: 'checkbox', value: char.id }).addClass('form-checkbox h-5 w-5 bg-gray-800 text-purple-600 rounded')).append($('<span></span>').text(char.name)).appendTo($groupCharSel);
                });
            }
            async function loadGroups() {
                const $groupList = $('#group-list').empty();
                const groups = await new Promise(r => getStore('groups', 'readonly').getAll().onsuccess = e => r(e.target.result));
                groups.forEach(group => renderListItem($groupList, group, 'group'));
            }
            async function loadWorldbooks() {
                const $listEl = $('#world-list').empty();
                const entries = await new Promise(r => getStore('worldbooks', 'readonly').getAll().onsuccess = e => r(e.target.result));
                entries.forEach(entry => {
                    $('<li></li>').addClass('sidebar-item p-2 rounded-lg cursor-pointer flex justify-between items-center').text(`${entry.keywords.split(/[,ï¼Œ]/)[0].trim()}...`).attr('title', entry.keywords).append($('<span></span>').text('âœï¸').addClass('text-sm opacity-50 hover:opacity-100').on('click', e => { e.stopPropagation(); editWorldbook(entry.id); })).appendTo($listEl);
                });
            }

            // --- CRUD OPERATIONS ---
            function setupDeleteConfirmation(btnId, originalTextKey, deleteFn) {
                const $btn = $(`#${btnId}`);
                const originalText = i18n[currentLang][originalTextKey];
                if ($btn.attr('data-confirming')) deleteFn();
                else {
                    $btn.attr('data-confirming', 'true').text(i18n[currentLang].deleteConfirm).removeClass('bg-red-600 hover:bg-red-700').addClass('bg-yellow-500 hover:bg-yellow-600');
                    setTimeout(() => { if ($btn.attr('data-confirming')) $btn.removeAttr('data-confirming').text(originalText).removeClass('bg-yellow-500 hover:bg-yellow-600').addClass('bg-red-600 hover:bg-red-700'); }, 3000);
                }
            }

            function saveCharacter(e) {
                e.preventDefault();
                const id = $('#char-id').val(), name = $('#char-name').val().trim().replace(/\s+/g, '_');
                if (!name) return showToast('charNameCannotBeEmpty');
                const isPlayer = $('#char-is-player').prop('checked');
                const data = { name, persona: $('#char-persona').val(), greeting: $('#char-greeting').val(), isPlayer };

                // å¦‚æœè®¾ç½®ä¸ºä¸»è§’ï¼Œå…ˆæ¸…é™¤å…¶ä»–ä¸»è§’è®¾ç½®
                if (isPlayer) {
                    const charStore = getStore('characters', 'readwrite');
                    const getAllReq = charStore.getAll();
                    getAllReq.onsuccess = function () {
                        const allChars = getAllReq.result;
                        const playerChars = allChars.filter(char => char.isPlayer && (!id || char.id !== parseInt(id)));

                        // æ¸…é™¤å…¶ä»–ä¸»è§’è®¾ç½®
                        playerChars.forEach(char => {
                            char.isPlayer = false;
                            charStore.put(char);
                        });

                        // ä¿å­˜å½“å‰è§’è‰²
                        const saveReq = id ? charStore.put({ ...data, id: parseInt(id) }) : charStore.add(data);
                        saveReq.onsuccess = function (e) {
                            const charId = id ? parseInt(id) : e.target.result;
                            if (isPlayer) {
                                // æ›´æ–°å½“å‰ä¸»è§’
                                const char = { ...data, id: charId };
                                currentState.playerCharacter = char;
                                currentState.characterCache.set(charId, char);
                            } else if (currentState.playerCharacter && currentState.playerCharacter.id === charId) {
                                // å¦‚æœå–æ¶ˆäº†å½“å‰ä¸»è§’çš„è®¾ç½®
                                currentState.playerCharacter = null;
                            }
                            showEditor(null);
                            loadAndRenderAll();
                        };
                    };
                } else {
                    // æ™®é€šè§’è‰²ç›´æ¥ä¿å­˜
                    const req = id ? getStore('characters', 'readwrite').put({ ...data, id: parseInt(id) }) : getStore('characters', 'readwrite').add(data);
                    req.onsuccess = (e) => {
                        const charId = id ? parseInt(id) : e.target.result;
                        if (currentState.playerCharacter && currentState.playerCharacter.id === charId) {
                            // å¦‚æœå–æ¶ˆäº†å½“å‰ä¸»è§’çš„è®¾ç½®
                            currentState.playerCharacter = null;
                        }
                        showEditor(null);
                        loadAndRenderAll();
                    };
                }
            }
            function editCharacter(id) {
                const char = currentState.characterCache.get(id); if (!char) return;
                clearForms();
                $('#char-id').val(char.id);
                $('#char-name').val(char.name);
                $('#char-persona').val(char.persona);
                $('#char-greeting').val(char.greeting);
                $('#char-is-player').prop('checked', !!char.isPlayer);
                $('#delete-char-btn').show();
                showEditor('char');
            }
            function deleteCharacter() {
                setupDeleteConfirmation('delete-char-btn', 'deleteChar', async () => {
                    const id = parseInt($('#char-id').val()); if (!id) return;
                    await new Promise(r => getStore('characters', 'readwrite').delete(id).onsuccess = r);
                    const groupStore = getStore('groups', 'readwrite');
                    const groups = await new Promise(r => groupStore.getAll().onsuccess = e => r(e.target.result));
                    for (const group of groups.filter(g => g.characterIds.includes(id))) {
                        await new Promise(r => groupStore.delete(group.id).onsuccess = r);
                        await deleteChatHistory(`group_${group.id}`);
                    }
                    await deleteChatHistory(`char_${id}`);
                    await loadAndRenderAll(); showEditor(null);
                    if (currentState.sessionId?.includes(`_${id}`)) showWelcomeScreen();
                });
            }

            function saveGroup(e) {
                e.preventDefault();
                const id = $('#group-id').val();
                const characterIds = $('#group-char-selection input:checked').map((_, el) => parseInt($(el).val())).get();
                if (characterIds.length < 1) return showToast('groupNeedOneChar');
                const data = { name: $('#group-name').val(), characterIds };
                const req = id ? getStore('groups', 'readwrite').put({ ...data, id: parseInt(id) }) : getStore('groups', 'readwrite').add(data);
                req.onsuccess = () => { showEditor(null); loadAndRenderAll(); };
            }
            function editGroup(id) {
                getStore('groups', 'readonly').get(id).onsuccess = e => {
                    const group = e.target.result; clearForms();
                    $('#group-id').val(group.id); $('#group-name').val(group.name);
                    $('#group-char-selection input').each(function () { $(this).prop('checked', group.characterIds.includes(parseInt($(this).val()))); });
                    $('#delete-group-btn').show(); showEditor('group');
                };
            }
            function deleteGroup() {
                setupDeleteConfirmation('delete-group-btn', 'deleteGroup', async () => {
                    const id = parseInt($('#group-id').val()); if (!id) return;
                    await new Promise(r => getStore('groups', 'readwrite').delete(id).onsuccess = r);
                    await deleteChatHistory(`group_${id}`);
                    await loadAndRenderAll(); showEditor(null);
                    if (currentState.sessionId === `group_${id}`) showWelcomeScreen();
                });
            }

            function saveWorldbook(e) {
                e.preventDefault();
                const id = $('#world-id').val();
                const data = { keywords: $('#world-keywords').val(), content: $('#world-content').val() };
                const req = id ? getStore('worldbooks', 'readwrite').put({ ...data, id: parseInt(id) }) : getStore('worldbooks', 'readwrite').add(data);
                req.onsuccess = () => { showEditor(null); loadAndRenderAll(); };
            }
            function editWorldbook(id) {
                getStore('worldbooks', 'readonly').get(id).onsuccess = e => {
                    const entry = e.target.result; clearForms();
                    $('#world-id').val(entry.id); $('#world-keywords').val(entry.keywords);
                    $('#world-content').val(entry.content);
                    $('#delete-world-btn').show(); showEditor('world');
                };
            }
            function deleteWorldbook() {
                setupDeleteConfirmation('delete-world-btn', 'deleteEntry', () => {
                    const id = parseInt($('#world-id').val()); if (!id) return;
                    getStore('worldbooks', 'readwrite').delete(id).onsuccess = () => { loadAndRenderAll(); showEditor(null); };
                });
            }

            // --- SESSION & CHAT LOGIC ---
            function showWelcomeScreen() { $('#chat-area').hide(); $('#chat-welcome').show(); $('.sidebar-item').removeClass('active'); currentState.sessionId = null; currentState.sessionType = null; }
            async function selectSession(id, type) {
                currentState.sessionId = `${type}_${id}`; currentState.sessionType = type;
                $('.sidebar-item').removeClass('active');
                $(`.sidebar-item[data-id='${id}'][data-type='${type}']`).addClass('active');
                $('#chat-welcome').hide(); $('#chat-area').show();
                let sessionName = '', participants = '', initialMessages = [];
                if (type === 'character') {
                    const char = currentState.characterCache.get(id);
                    sessionName = char.name; participants = `ä¸ ${char.name} å¯¹è¯ä¸­`;
                    initialMessages.push({ role: 'char', content: char.greeting, characterId: id, characterName: char.name });
                } else {
                    const group = await new Promise(r => getStore('groups', 'readonly').get(id).onsuccess = e => r(e.target.result));
                    sessionName = group.name;
                    const charNames = group.characterIds.map(cid => currentState.characterCache.get(cid)?.name || 'æœªçŸ¥');
                    participants = `å‚ä¸è€…: ${charNames.join(', ')}`;
                    initialMessages.push({ role: 'system', content: `ç¾¤èŠ "${group.name}" å¼€å§‹äº†ã€‚` });
                }
                $('#chat-session-name').text(sessionName); $('#chat-participants').text(participants);
                loadChatHistory(currentState.sessionId, initialMessages);
            }
            async function loadChatHistory(sessionId, initialMessages) {
                const messages = await new Promise(r => getStore('chat_history', 'readonly').index('sessionId').getAll(sessionId).onsuccess = e => r(e.target.result));
                $('#chat-history').empty();
                if (messages.length === 0 && initialMessages.length > 0) {
                    for (const msg of initialMessages) {
                        addMessageToChat(msg.role, msg.content, msg.characterName);
                        if (msg.role !== 'system') saveMessage(sessionId, msg.role, msg.content, msg.characterId, msg.characterName);
                    }
                } else messages.forEach(msg => addMessageToChat(msg.role, msg.content, msg.characterName));
            }
            function addMessageToChat(role, content, characterName = null) {
                const $historyContainer = $('#chat-history-container');
                const $bubble = $('<div></div>').addClass('p-3 rounded-lg chat-bubble').text(content);
                const $msgWrapper = $('<div></div>').addClass('flex flex-col').append($bubble);
                if (role === 'user') $msgWrapper.addClass('items-end').find('.chat-bubble').addClass('chat-bubble-user');
                else if (role === 'system') $msgWrapper.addClass('items-center').find('.chat-bubble').addClass('text-sm text-gray-400 italic text-center');
                else $msgWrapper.addClass('items-start whitespace-pre-line').find('.chat-bubble').addClass('chat-bubble-char').end().prepend($('<div></div>').addClass('speaker-name').text(characterName || 'æ—ç™½'));
                $('#chat-history').append($msgWrapper);
                $historyContainer.scrollTop($historyContainer[0].scrollHeight);
            }
            function saveMessage(sessionId, role, content, characterId = null, characterName = null) {
                getStore('chat_history', 'readwrite').add({ sessionId, role, content, characterId, characterName, timestamp: new Date() });
            }
            function deleteChatHistory(sessionId) {
                const index = getStore('chat_history', 'readwrite').index('sessionId');
                const request = index.openCursor(IDBKeyRange.only(sessionId));
                request.onsuccess = e => { const cursor = e.target.result; if (cursor) { cursor.delete(); cursor.continue(); } };
                return request;
            }
            async function handleSendMessage() {
                const text = $('#user-input').val().trim();
                if (!text || !currentState.sessionId) return;

                // ç¡®å®šæ¶ˆæ¯å‘é€è€…è§’è‰²
                const isPlayerSpeaking = !!currentState.playerCharacter;
                const role = isPlayerSpeaking ? 'char' : 'user';
                const characterName = isPlayerSpeaking ? currentState.playerCharacter.name : null;
                const characterId = isPlayerSpeaking ? currentState.playerCharacter.id : null;

                // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢å¹¶ä¿å­˜
                addMessageToChat(role, text, characterName);
                saveMessage(currentState.sessionId, role, text, characterId, characterName);

                $('#user-input').val('');
                addMessageToChat('char', 'æ€è€ƒä¸­...', 'AI');

                try {
                    const participants = await getSessionParticipants();
                    let mentionedChar = null;
                    const match = text.match(/@([\p{L}\p{N}_]+)/u);
                    if (match) {
                        const mentionedName = match[1];
                        mentionedChar = participants.find(p => p.name === mentionedName || p.name.toLowerCase() === mentionedName.toLowerCase());
                    }

                    // æ„å»ºæç¤ºå¹¶è·å–AIå“åº”
                    const prompt = await constructPrompt(mentionedChar ? mentionedChar.name : null);
                    const responseText = await getAIResponse(prompt);
                    $('#chat-history').children().last().remove();

                    // å¤„ç†AIå“åº” - é¦–å…ˆæ¸…ç†<think>æ ‡ç­¾
                    let cleanedResponse = responseText;
                    // ç§»é™¤<think>...</think>æ ‡ç­¾åŠå…¶å†…å®¹
                    cleanedResponse = cleanedResponse.replace(/<think>[\s\S]*?<\/think>/gi, '').trim();

                    let respCharName = null, content = cleanedResponse;
                    const parts = cleanedResponse.split(':');

                    // å¦‚æœæœ‰@æåŠï¼Œä¼˜å…ˆè®©è¢«@çš„è§’è‰²å›åº”
                    if (mentionedChar && parts.length > 1) {
                        const firstPart = parts[0].trim();
                        // æ£€æŸ¥AIæ˜¯å¦æŒ‰ç…§æŒ‡å®šæ ¼å¼å›å¤ï¼ˆè§’è‰²å: å¯¹è¯å†…å®¹ï¼‰
                        if (firstPart === mentionedChar.name || firstPart.toLowerCase() === mentionedChar.name.toLowerCase()) {
                            respCharName = mentionedChar.name;
                            content = parts.slice(1).join(':').trim();
                        } else {
                            // å¦‚æœAIæ²¡æœ‰æŒ‰ç…§æ ¼å¼å›å¤ï¼Œå¼ºåˆ¶è®¾ç½®ä¸ºè¢«@çš„è§’è‰²
                            respCharName = mentionedChar.name;
                            content = cleanedResponse;
                        }
                    } else {
                        // æ²¡æœ‰@æåŠæ—¶ï¼Œå°è¯•è§£æè§’è‰²å
                        const speakingChar = participants.find(p => p.name === parts[0].trim());
                        if (speakingChar && parts.length > 1) {
                            respCharName = speakingChar.name;
                            content = parts.slice(1).join(':').trim();
                        }
                    }

                    // æ·»åŠ AIå“åº”åˆ°èŠå¤©ç•Œé¢å¹¶ä¿å­˜
                    const finalCharId = respCharName ? participants.find(p => p.name === respCharName)?.id : null;
                    const displayName = respCharName || (mentionedChar ? mentionedChar.name : null);
                    addMessageToChat('char', content, displayName);
                    saveMessage(currentState.sessionId, 'char', content, finalCharId, displayName);
                } catch (error) {
                    console.error('Error:', error);
                    $('#chat-history').children().last().remove();
                    addMessageToChat('char', `æŠ±æ­‰ï¼Œæˆ‘å‡ºé”™äº†: ${error.message}`, 'ç³»ç»Ÿ');
                }
            }
            async function getSessionParticipants() {
                if (!currentState.sessionId) return [];
                const [type, idStr] = currentState.sessionId.split('_');
                const id = parseInt(idStr);
                if (type === 'character') return [currentState.characterCache.get(id)].filter(Boolean);
                if (type === 'group') {
                    const group = await new Promise(r => getStore('groups', 'readonly').get(id).onsuccess = e => r(e.target.result));
                    return group ? group.characterIds.map(cid => currentState.characterCache.get(cid)).filter(Boolean) : [];
                } return [];
            }
            async function constructPrompt(targetCharacterName = null) {
                const participants = await getSessionParticipants();
                const history = (await new Promise(r => getStore('chat_history', 'readonly').index('sessionId').getAll(currentState.sessionId).onsuccess = e => r(e.target.result))).slice(-15);
                const convoText = history.map(h => h.content).join('\n');
                const worldbooks = await new Promise(r => getStore('worldbooks', 'readonly').getAll().onsuccess = e => r(e.target.result));
                const triggeredWorlds = worldbooks.filter(w => w.keywords.split(/[,ï¼Œ]/).some(k => convoText.toLowerCase().includes(k.trim().toLowerCase())));

                // æ„å»ºåœºæ™¯è§’è‰²éƒ¨åˆ†
                let prompt = "[System Note: This is a roleplay conversation.]\n\n== CHARACTERS IN THIS SCENE ==\n";
                participants.forEach(p => { prompt += `Name: ${p.name}\nPersona: ${p.persona}\n\n`; });

                // æ·»åŠ ä¸–ç•Œè®¾å®š
                if (triggeredWorlds.length > 0) {
                    prompt += "== RELEVANT WORLDBOOK ENTRIES ==\n";
                    triggeredWorlds.forEach(w => prompt += `Content for "${w.keywords}": ${w.content}\n\n`);
                }

                // æ·»åŠ å¯¹è¯å†å²
                prompt += "== RECENT CONVERSATION HISTORY ==\n";

                // æ£€æŸ¥æ˜¯å¦æœ‰ä¸»è§’è§’è‰²
                const hasPlayerCharacter = !!currentState.playerCharacter;

                // æ ¹æ®æ˜¯å¦æœ‰ä¸»è§’è§’è‰²ï¼Œè°ƒæ•´å†å²æ¶ˆæ¯çš„æ˜¾ç¤ºæ–¹å¼
                history.forEach(msg => {
                    let speakerName;
                    if (msg.role === 'user') {
                        // å¦‚æœæ²¡æœ‰ä¸»è§’ï¼Œæ˜¾ç¤ºä¸ºUserï¼Œå¦åˆ™å·²ç»åœ¨characterNameä¸­æ˜¾ç¤ºäº†ä¸»è§’åç§°
                        speakerName = hasPlayerCharacter ? (msg.characterName || 'User') : 'User';
                    } else {
                        speakerName = msg.characterName || 'æ—ç™½';
                    }
                    prompt += `${speakerName}: ${msg.content}\n`;
                });

                // æ„å»ºè§’è‰²æ‰®æ¼”æŒ‡ä»¤
                let roleplayInstruction = '';
                const isGroup = currentState.sessionType === 'group' && participants.length > 1;

                // æ·»åŠ åŸºç¡€AIæ§åˆ¶è§„åˆ™
                let aiControlRules = 'IMPORTANT: AI can only control the behaviors and dialogues of non-player characters, and must never speak or act on behalf of the player character.';
                if (hasPlayerCharacter) {
                    aiControlRules += `The player character is ${currentState.playerCharacter.name}, and the AI must never control this character.`;
                }

                if (isGroup) {
                    if (targetCharacterName) {
                        // å¦‚æœæœ‰ä¸»è§’ï¼Œè°ƒæ•´æç¤ºä»¥åæ˜ ç”¨æˆ·æ˜¯ä»¥ä¸»è§’èº«ä»½è¯´è¯
                        if (hasPlayerCharacter) {
                            roleplayInstruction = `${aiControlRules} ${currentState.playerCharacter.name} speaks directly to ${targetCharacterName}. ${targetCharacterName} MUST respond. Format: '${targetCharacterName}: Their dialogue'.`;
                        } else {
                            roleplayInstruction = `${aiControlRules} The User speaks directly to ${targetCharacterName}. ${targetCharacterName} MUST respond. Format: '${targetCharacterName}: Their dialogue'.`;
                        }
                    } else {
                        roleplayInstruction = `${aiControlRules} You are the roleplay master, responsible for driving the story forward. Based on the characters and world setting, you MUST decide who speaks next OR provide narration. Narration is crucial for describing the environment, introducing new events, or revealing challenges. For example, 'A cold wind blows through the trees, carrying the scent of decay.' Use narration to make the story dynamic and interesting. For character dialogue, use the format 'CharacterName: Their dialogue'. For narration, omit the prefix.`;
                    }
                } else {
                    // å•è§’è‰²å¯¹è¯
                    if (hasPlayerCharacter && participants[0].name === currentState.playerCharacter.name) {
                        roleplayInstruction = `${aiControlRules} Wait for the input from the player character ${currentState.playerCharacter.name}. The AI cannot speak on behalf of the player.`;
                    } else {
                        roleplayInstruction = `${aiControlRules} Continue as ${participants[0].name}. Do not include your name as a prefix.`;
                    }
                }

                // æ·»åŠ è¯­è¨€æŒ‡ä»¤
                const langInstruction = currentLang === 'zh-CN' ? 'ä½ å¿…é¡»åªä½¿ç”¨ç®€ä½“ä¸­æ–‡è¿›è¡Œå›å¤ã€‚' : 'You MUST respond only in English.';

                // å¦‚æœæœ‰ä¸»è§’ï¼Œæ·»åŠ é¢å¤–è¯´æ˜
                if (hasPlayerCharacter) {
                    prompt += `\n[System Note: ä¸¥æ ¼è§„åˆ™ï¼šç©å®¶è§’è‰²æ˜¯ ${currentState.playerCharacter.name}ï¼ŒAIç»ä¸èƒ½ä»£æ›¿æ­¤è§’è‰²è¯´è¯æˆ–è¡ŒåŠ¨ã€‚å‰§æƒ…åªèƒ½æ ¹æ® ${currentState.playerCharacter.name} çš„å¯¹è¯æ¥æ¨è¿›ã€‚å¦‚æœæ²¡æœ‰è¯´æ˜è§’è‰²åº”è¯¥äº’ç›¸ä¸è®¤è¯†ï¼Œåº”è¯¥éšç€è§’è‰²ä¹‹é—´çš„å¯¹è¯æ¥ç¼“æ…¢æ¨è¿›å‰§æƒ…ã€‚ ${roleplayInstruction} Final instruction: ${langInstruction}]`;
                } else {
                    prompt += `\n[System Note: ${roleplayInstruction} Final instruction: ${langInstruction}]`;
                }

                return prompt;
            }
            async function getAIResponse(prompt) {
                console.log("--- PROMPT SENT TO AI ---\n", prompt);
                const { apiKey, apiUrl, model } = currentState.worldConfig;
                let response;
                if (apiUrl.includes('googleapis.com')) {
                    const fullApiUrl = `${apiUrl}?key=${apiKey}`;
                    response = await fetch(fullApiUrl, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: prompt }] }] })
                    });
                } else {
                    response = await fetch(apiUrl, {
                        method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                        body: JSON.stringify({ model: model, messages: [{ role: 'user', content: prompt }] })
                    });
                }
                if (!response.ok) {
                    const errorBody = await response.json(); throw new Error(`API Error: ${errorBody.error?.message || JSON.stringify(errorBody)}`);
                }
                const result = await response.json();

                if (result.choices && result.choices[0]?.message) {
                    let content;
                    if (result.choices[0].message?.content) {
                        content = result.choices[0].message.content;
                    } else if (result.choices[0].message?.reasoning_content) {
                        content = result.choices[0].message?.reasoning_content;
                    }
                    // æ¸…ç†æ€è€ƒæ ‡ç­¾å¹¶æ›¿æ¢è‹±æ–‡Narrationä¸ºä¸­æ–‡æ—ç™½
                    return content.replace(/<think>[\s\S]*?<\/think>/g, '').replace(/\[?Narration:/gi, 'æ—ç™½:');
                } else {
                    if (result.promptFeedback?.blockReason) {
                        return `[å†…å®¹è¢«é˜»æ­¢: ${result.promptFeedback.blockReason}]`;
                    }
                    return "[AIæœªèƒ½ç”Ÿæˆæœ‰æ•ˆå›å¤]";
                }
            }

            // --- @MENTION SUGGESTIONS ---
            const $userInput = $('#user-input'), $suggestionsBox = $('#mention-suggestions'); let mentionStartIndex = -1;
            async function handleMentionInput() {
                const textUpToCursor = $userInput.val().substring(0, $userInput[0].selectionStart);
                const mentionMatch = textUpToCursor.match(/@([\p{L}\p{N}_]*)$/u);
                if (mentionMatch) {
                    const participants = await getSessionParticipants();
                    if (participants.length > 1) {
                        mentionStartIndex = mentionMatch.index;
                        const partialName = mentionMatch[1].toLowerCase();
                        const suggestions = participants.filter(p => p.name.toLowerCase().startsWith(partialName));
                        renderMentionSuggestions(suggestions); return;
                    }
                } hideMentionSuggestions();
            }
            function renderMentionSuggestions(suggestions) {
                if (suggestions.length === 0) return hideMentionSuggestions();
                $suggestionsBox.empty();
                suggestions.forEach(char => {
                    $('<div></div>').text(char.name).addClass('p-2 px-3 cursor-pointer hover:bg-gray-600 rounded-md')
                        .on('mousedown', e => { e.preventDefault(); selectMention(char.name); }).appendTo($suggestionsBox);
                });
                $suggestionsBox.show();
            }
            function hideMentionSuggestions() { if ($suggestionsBox.is(':visible')) $suggestionsBox.hide(); mentionStartIndex = -1; }
            function selectMention(name) {
                const currentText = $userInput.val(); const textBefore = currentText.substring(0, mentionStartIndex);
                const textAfter = currentText.substring($userInput[0].selectionStart);
                $userInput.val(`${textBefore}@${name} ${textAfter}`);
                hideMentionSuggestions(); $userInput.focus();
                const newCursorPos = (textBefore + `@${name} `).length;
                $userInput[0].setSelectionRange(newCursorPos, newCursorPos);
            }

            // --- APP INITIALIZATION ---
            function initializeAppLogic() {
                populateEditors();
                $('#config-editor').on('submit', saveWorldConfig);
                $('#char-editor').on('submit', saveCharacter);
                $('#delete-char-btn').on('click', deleteCharacter);
                $('#world-editor').on('submit', saveWorldbook);
                $('#delete-world-btn').on('click', deleteWorldbook);
                $('#group-editor').on('submit', saveGroup);
                $('#delete-group-btn').on('click', deleteGroup);

                loadAndRenderAll();
                $('#new-char-btn').on('click', () => showEditor('char'));
                $('#new-group-btn').on('click', () => showEditor('group'));
                $('#new-world-btn').on('click', () => showEditor('world'));
                $('#edit-config-btn').on('click', () => editWorldConfig());
                $('#send-btn').on('click', () => { handleSendMessage(); hideMentionSuggestions(); });
                $userInput.on('keydown', e => {
                    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); hideMentionSuggestions(); }
                    if (e.key === 'Escape') hideMentionSuggestions();
                });
                $userInput.on('input click', handleMentionInput); $userInput.on('blur', () => setTimeout(hideMentionSuggestions, 150));
            }

            // --- START THE APP ---
            $('#create-world-btn').on('click', () => {
                const newWorldName = $('#new-world-name').val().trim();
                enterWorld(newWorldName);
            });
            $('#enter-world-btn').on('click', () => {
                const selectedWorld = $('#world-select-dropdown').val();
                if (selectedWorld) enterWorld(selectedWorld);
                else showToast('alertSelectWorld');
            });
            $('#new-world-name').on('keydown', e => { if (e.key === 'Enter') $('#create-world-btn').trigger('click'); });
            $('#import-world-btn').on('click', () => $('#import-world-file').click());
            $('#import-world-file').on('change', handleImportFile);
            $('#lang-switcher').on('click', () => { const newLang = currentLang === 'zh-CN' ? 'en-US' : 'zh-CN'; setLanguage(newLang, true); });

            setLanguage(getLanguage());
            showWorldSelectionDialog();

        });
    </script>
</body>

</html>